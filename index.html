<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelas Digital: Portal Tugas Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font baru: Cormorant Garamond & Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Latar belakang animasi gradasi lilac */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #ede9fe, #ddd6fe, #c4b5fd, #a78bfa);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Mengaplikasikan font baru */
        body, h1, h2, h3, button, select {
            font-family: 'Cormorant Garamond', serif;
        }
        /* Menggunakan font Poppins untuk teks deskripsi agar mudah dibaca */
        p, td, th, label, textarea, input, span, a {
            font-family: 'Poppins', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        /* Animasi untuk Modal dan Notifikasi */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }

        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out-up {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); visibility: hidden; }
        }
        .animate-fade-in-down { animation: fade-in-down 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fade-out-up 0.5s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800">
    
    <div class="animated-bg"></div>

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
    </div>

    <!-- Container untuk Modal -->
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>
    
    <!-- Container untuk Notifikasi Toast -->
    <div id="notification-container" class="fixed top-5 right-5 z-[100] w-full max-w-xs sm:max-w-sm"></div>

    <!-- Modal Manajemen Pengguna (khusus admin) -->
    <div id="user-modal" class="hidden fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg animate-fade-in-up">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="user-modal-title" class="text-2xl font-bold">Tambah Pengguna</h3>
                <button data-action="close-user-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <form id="user-form">
                <div class="p-6 space-y-4">
                        <input type="hidden" id="user-id">
                    <div>
                        <label for="user-nama" class="block mb-1 font-medium">Nama Lengkap</label>
                        <input type="text" id="user-nama" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="user-username" class="block mb-1 font-medium">Username</label>
                        <input type="text" id="user-username" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="user-password" class="block mb-1 font-medium">Password</label>
                        <input type="password" id="user-password" class="w-full p-2 border rounded-md">
                        <p id="password-hint" class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah password.</p>
                    </div>
                    <div>
                        <label for="user-role" class="block mb-1 font-medium">Peran</label>
                        <select id="user-role" class="w-full p-2 border rounded-md bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="guru">Guru</option>
                        </select>
                    </div>
                    <p id="user-error" class="text-red-500 text-sm hidden"></p>
                </div>
                <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                   <button type="button" data-action="close-user-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                   <button type="submit" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // KONFIGURASI SUPABASE (GANTI DENGAN KUNCI ANDA)
            // =================================================================================
            const SUPABASE_URL = 'https://ohluflprnebfsescgryg.supabase.co'; // <-- GANTI DENGAN URL ANDA
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9obHVmbHBybmViZnNlc2NncnlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODQ5MDgsImV4cCI6MjA3NjY2MDkwOH0.F2a_P9zSoRGaiep0qSe22qVqvFSnajFZ7OzYRl13Qts'; // <-- GANTI DENGAN KUNCI ANON ANDA

            const appContainer = document.getElementById('app');
            
            // Cek apakah kredensial sudah diisi
            if (SUPABASE_URL === 'URL_ANDA_DARI_SUPABASE' || SUPABASE_ANON_KEY === 'KUNCI_ANON_ANDA_DARI_SUPABASE') {
                appContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg max-w-2xl mx-auto mt-10 animate-fade-in-up">
                    <h2 class="font-bold text-xl mb-2">Konfigurasi Database Diperlukan!</h2>
                    <p class="font-sans">Anda harus mengedit file <strong>index.html</strong> ini.</p>
                    <p class="font-sans mt-2">Salin <code>URL</code> dan <code>Kunci ANON</code> dari proyek Supabase Anda dan tempelkan ke variabel <strong>SUPABASE_URL</strong> dan <strong>SUPABASE_ANON_KEY</strong> di baris atas tag script.</p>
                    <p class="font-sans mt-2">Silakan ikuti panduan di file <strong>panduan_supabase.md</strong> untuk mendapatkannya.</p>
                </div>`;
                return; // Menghentikan eksekusi skrip jika belum dikonfigurasi
            }

            // Inisialisasi Supabase Client
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


            // =================================================================================
            // STATE & DATA MANAGEMENT
            // =================================================================================
            // State sekarang hanya menyimpan data sesi. Data utama akan diambil dari Supabase.
            let state = {
                currentUserRole: null, 
                currentUserName: null, 
                currentUserId: null,
                users: {
                    superadmin: [],
                    guru: [],
                    siswa: []
                },
                tugas: [],
                pengumpulan: []
            };

            const modalContainer = document.getElementById('modal-container');
            const userModal = document.getElementById('user-modal');
            const userForm = document.getElementById('user-form');
            const userModalTitle = document.getElementById('user-modal-title');
            const userError = document.getElementById('user-error');
            const passwordHint = document.getElementById('password-hint');

            // =================================================================================
            // HELPER FUNCTIONS
            // =================================================================================
            const formatDate = (date) => {
                if (!date || isNaN(new Date(date))) return 'Invalid Date';
                return new Intl.DateTimeFormat('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                }).format(new Date(date));
            };
            
            const toDateTimeLocal = (date) => {
                const dt = new Date(date);
                dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
                return dt.toISOString().slice(0, 16);
            };

            const getStatusTugas = (tugas, pengumpulan) => {
                const now = new Date();
                if (pengumpulan) {
                    return { text: 'Terkumpul', color: 'violet', icon: 'fa-check-circle' };
                }
                if (now > new Date(tugas.deadline)) {
                    return { text: 'Terlambat', color: 'red', icon: 'fa-times-circle' };
                }
                return { text: 'Belum Dikumpulkan', color: 'gray', icon: 'fa-clock' };
            };
            
            const getStatusPengumpulan = (pengumpulan, tugas) => {
                 if (new Date(pengumpulan.tanggalKumpul) <= new Date(tugas.deadline)) {
                     return { text: 'Tepat Waktu', color: 'green' };
                }
                return { text: 'Terlambat', color: 'red' };
            }

            const showNotification = (message, type = 'success') => {
                const container = document.getElementById('notification-container');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

                const toast = document.createElement('div');
                toast.className = `p-4 rounded-lg shadow-lg text-white ${bgColor} animate-fade-in-down mb-2 flex items-center`;
                toast.innerHTML = `<i class="fas ${icon} mr-3"></i> <span class="font-sans">${message}</span>`;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('animate-fade-in-down');
                    toast.classList.add('animate-fade-out-up');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            };
            
            // saveState sekarang HANYA menyimpan info login (sesi)
            const saveState = () => {
                const sessionData = {
                    currentUserRole: state.currentUserRole,
                    currentUserName: state.currentUserName,
                    currentUserId: state.currentUserId
                };
                localStorage.setItem('kelasDigitalSession', JSON.stringify(sessionData));
            };

            // loadState sekarang HANYA memuat info login (sesi)
            const loadState = () => {
                const savedSession = localStorage.getItem('kelasDigitalSession');
                if (savedSession) {
                    const parsedSession = JSON.parse(savedSession);
                    Object.assign(state, parsedSession);
                }
            };

            // Fungsi BARU untuk memuat semua data dari Supabase
            const loadDataFromSupabase = async () => {
                // Tampilkan loader
                appContainer.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-violet-600"></i><p class="font-sans text-lg mt-2">Memuat data dari database...</p></div>`;

                try {
                    // 1. Ambil data users
                    const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                    if (usersError) throw usersError;

                    // 2. Ambil data tugas
                    const { data: tugasData, error: tugasError } = await supabase.from('tugas').select('*');
                    if (tugasError) throw tugasError;

                    // 3. Ambil data pengumpulan
                    const { data: pengumpulanData, error: pengumpulanError } = await supabase.from('pengumpulan').select('*');
                    if (pengumpulanError) throw pengumpulanError;

                    // Proses dan masukkan data ke 'state' lokal
                    state.users = { superadmin: [], guru: [], siswa: [] };
                    usersData.forEach(user => {
                        if (state.users[user.role]) {
                            state.users[user.role].push(user);
                        }
                    });

                    state.tugas = tugasData.map(t => ({
                        ...t,
                        deadline: new Date(t.deadline) // Ubah string timestamp menjadi objek Date
                    }));

                    state.pengumpulan = pengumpulanData.map(p => ({
                        ...p,
                        tanggalKumpul: new Date(p.tanggalKumpul), // Ubah string timestamp menjadi objek Date
                        file: { name: p.file_name, size: p.file_size } // Rekonstruksi objek file
                    }));
                    
                    return true; // Sukses

                } catch (error) {
                    console.error('Error loading data from Supabase:', error.message);
                    appContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg max-w-2xl mx-auto mt-10 animate-fade-in-up">
                        <h2 class="font-bold text-xl mb-2">Error Terhubung ke Database!</h2>
                        <p class="font-sans">Gagal memuat data dari Supabase. Pesan error: ${error.message}</p>
                        <p class="font-sans mt-2">Pastikan URL dan Kunci Anon Anda benar, dan Anda telah (untuk sementara) menonaktifkan RLS (Row Level Security) pada tabel Anda seperti di panduan.</p>
                    </div>`;
                    return false; // Gagal
                }
            };


            // =================================================================================
            // RENDER FUNCTIONS (UI COMPONENTS)
            // =================================================================================
            // ... (Semua fungsi renderLogin, renderSuperAdminDashboard, renderGuruDashboard, renderSiswaDashboard, renderModal, closeModal tetap SAMA) ...
            const renderLogin = () => {
                appContainer.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="bg-white/80 backdrop-blur-sm p-8 rounded-xl shadow-lg w-full max-w-md text-center animate-fade-in-up">
                            <i class="fas fa-book-reader text-5xl text-violet-600 mb-4"></i>
                            <h1 class="text-4xl font-bold mb-2">Kelas Digital</h1>
                            <p class="text-gray-600 mb-6 text-base">Portal Tugas Modern. Silakan masuk.</p>
                            <div class="space-y-4 text-left">
                                <div>
                                    <label for="username" class="block mb-1 text-lg font-medium">Username</label>
                                    <input type="text" id="username" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-base" placeholder="Masukkan username">
                                </div>
                                <div>
                                    <label for="password" class="block mb-1 text-lg font-medium">Password</label>
                                    <input type="password" id="password" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-base" placeholder="Masukkan password">
                                </div>
                                <div>
                                    <label for="roleSelector" class="block mb-1 text-lg font-medium">Masuk sebagai</label>
                                    <select id="roleSelector" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 text-lg bg-white">
                                        <option value="siswa">Siswa</option>
                                        <option value="guru">Guru</option>
                                        <option value="superadmin">Super Admin</option>
                                    </select>
                                </div>
                            </div>
                            <p id="loginError" class="text-red-500 text-sm mt-4 hidden"></p>
                            <button id="loginBtn" class="w-full mt-6 bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition duration-300 text-xl">
                                Masuk
                            </button>
                        </div>
                    </div>
                `;
                // Attach login button listener specifically when login page is rendered
                document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
            };
            
            const renderSuperAdminDashboard = () => {
                // Bagian manajemen pengguna yang sudah disetujui
                const managedUsers = [...(state.users.guru || []), ...(state.users.siswa || [])]
                    .filter(user => user.status === 'approved')
                    .map(user => `
                        <tr class="border-b">
                            <td class="p-3">${user.nama}</td>
                            <td class="p-3">${user.username}</td>
                            <td class="p-3 capitalize">${(state.users.guru || []).find(u => u.id === user.id) ? 'Guru' : 'Siswa'}</td>
                            <td class="p-3 text-right">
                                <button data-action="edit-user" data-id="${user.id}" class="bg-yellow-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-yellow-600 mr-2"><i class="fas fa-edit"></i></button>
                                <button data-action="delete-user" data-id="${user.id}" class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-red-600"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');

                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Super Admin</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}!</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>

                        <!-- Manajemen Pengguna -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                               <h2 class="text-3xl font-semibold border-b pb-2">Manajemen Pengguna</h2>
                               <button data-action="add-user" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700 transition text-lg">
                                   <i class="fas fa-plus mr-2"></i>Tambah Pengguna
                               </button>
                            </div>
                            
                             <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-700">Daftar Pengguna Aktif</h3>
                             <div class="overflow-x-auto rounded-lg border">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3 text-left font-semibold">Nama</th>
                                            <th class="p-3 text-left font-semibold">Username</th>
                                            <th class="p-3 text-left font-semibold">Peran</th>
                                            <th class="p-3 text-right font-semibold">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>${managedUsers.length > 0 ? managedUsers : '<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada pengguna aktif.</td></tr>'}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderGuruDashboard = () => {
                const submissionsHtml = state.pengumpulan.map(p => {
                    const tugas = state.tugas.find(t => t.id === p.tugasId);
                    if (!tugas) return '';
                    const status = getStatusPengumpulan(p, tugas);
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4">${p.namaSiswa}</td>
                            <td class="p-4">${tugas.judul}</td>
                            <td class="p-4">
                                <a data-action="lihat-tugas" data-id="${p.id}" class="text-violet-600 hover:underline cursor-pointer font-medium">
                                    <i class="fas fa-file-alt mr-1"></i>${p.file.name}
                                </a>
                            </td>
                            <td class="p-4">${formatDate(p.tanggalKumpul)}</td>
                            <td class="p-4 font-medium text-${status.color}-600">${status.text}</td>
                            <td class="p-4">
                                <input type="number" data-id="${p.id}" value="${p.nilai || ''}" placeholder="0-100" class="w-20 p-1 border rounded nilai-input">
                            </td>
                            <td class="p-4">
                                <textarea data-id="${p.id}" placeholder="Beri komentar..." class="w-full p-1 border rounded komentar-input">${p.komentarGuru || ''}</textarea>
                            </td>
                            <td class="p-4">
                                <button data-action="simpan-penilaian" data-id="${p.id}" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600">Simpan</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Guru</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}! Anda dapat memeriksa tugas siswa di sini.</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                        
                        <div class="mb-6">
                             <button data-action="tambah-tugas" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700 transition text-lg">
                                 <i class="fas fa-plus mr-2"></i>Tambah Tugas Baru
                             </button>
                        </div>

                        <h2 class="text-3xl font-semibold mb-4">Tugas Terkumpul</h2>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="p-4 text-left font-semibold text-base">Nama Siswa</th>
                                        <th class="p-4 text-left font-semibold text-base">Tugas</th>
                                        <th class="p-4 text-left font-semibold text-base">File</th>
                                        <th class="p-4 text-left font-semibold text-base">Tanggal Kumpul</th>
                                        <th class="p-4 text-left font-semibold text-base">Status</th>
                                        <th class="p-4 text-left font-semibold text-base">Nilai</th>
                                        <th class="p-4 text-left font-semibold text-base">Komentar</th>
                                        <th class="p-4 text-left font-semibold text-base">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${submissionsHtml || '<tr><td colspan="8" class="text-center p-4">Belum ada tugas yang dikumpulkan.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };

            const renderSiswaDashboard = () => {
                const tugasHtml = state.tugas.map(tugas => {
                    const pengumpulan = state.pengumpulan.find(p => p.tugasId === tugas.id && p.siswaId === state.currentUserId);
                    const status = getStatusTugas(tugas, pengumpulan);

                    return `
                        <div class="bg-white/80 backdrop-blur-sm p-6 rounded-lg shadow transition hover:shadow-xl hover:-translate-y-1">
                            <div class="flex flex-wrap justify-between items-start gap-2">
                                <div>
                                    <h3 class="text-2xl font-bold text-violet-700">${tugas.judul}</h3>
                                    <p class="text-sm text-red-600 font-semibold mb-2">
                                        <i class="fas fa-calendar-times mr-1"></i> Deadline: ${formatDate(new Date(tugas.deadline))}
                                    </p>
                                    <p class="text-gray-600 mb-4">${tugas.deskripsi}</p>
                                </div>
                                <span class="text-sm font-medium text-${status.color}-600 bg-${status.color}-100 px-3 py-1 rounded-full whitespace-nowrap">
                                    <i class="fas ${status.icon} mr-1"></i>
                                    ${status.text}
                                </span>
                            </div>
                            
                            ${pengumpulan ? `
                                <div class="mt-4 border-t pt-4">
                                    <p class="font-semibold text-base">Tugas Anda:</p>
                                    <div class="flex items-center text-gray-700 bg-gray-100 p-2 rounded-md mt-2">
                                        <i class="fas fa-file-alt text-lg mr-3"></i>
                                        <span>${pengumpulan.file.name}</span>
                                    </div>
                                    ${pengumpulan.nilai !== null ? `
                                        <div class="mt-3">
                                            <p class="font-semibold text-base">Nilai: <span class="text-2xl font-bold text-green-600">${pengumpulan.nilai}</span></p>
                                        </div>
                                        <div class="mt-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                                            <p class="font-bold text-base">Komentar dari Guru:</p>
                                            <p>${pengumpulan.komentarGuru || '<i>Belum ada komentar.</i>'}</p>
                                        </div>
                                    ` : `
                                        <p class="mt-3 text-sm text-gray-500">Tugas Anda sedang diperiksa oleh guru.</p>
                                    `}
                                </div>
                            ` : `
                                <button data-action="kumpul-tugas" data-id="${tugas.id}" class="mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-lg"
                                    ${new Date() > new Date(tugas.deadline) ? 'disabled' : ''}>
                                    <i class="fas fa-upload mr-2"></i>${new Date() > new Date(tugas.deadline) ? 'Waktu Habis' : 'Kumpulkan Tugas'}
                                </button>
                            `}
                        </div>
                    `;
                }).join('');

                appContainer.innerHTML = `
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg animate-fade-in-up">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                            <div>
                                <h1 class="text-4xl font-bold">Dashboard Siswa</h1>
                                <p class="text-gray-500">Selamat datang, ${state.currentUserName}!</p>
                            </div>
                            <button data-action="logout" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition text-lg">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                        <h2 class="text-3xl font-semibold mb-4">Daftar Tugas</h2>
                        <div class="space-y-4">
                            ${tugasHtml || '<p>Belum ada tugas yang diberikan.</p>'}
                        </div>
                    </div>
                `;
            };
            
            const renderModal = ({ title, body, footer }) => {
                modalContainer.innerHTML = `
                    <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg animate-fade-in-up">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="text-2xl font-bold">${title}</h3>
                                <button data-action="close-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                            </div>
                            <div class="p-6">${body}</div>
                            <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                                ${footer}
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.classList.remove('hidden');
            };
            
            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContainer.innerHTML = '';
            }

            // =================================================================================
            // EVENT HANDLERS & ACTIONS (DIMODIFIKASI UNTUK SUPABASE)
            // =================================================================================

            const handleLogin = async () => {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('roleSelector').value;
                const errorEl = document.getElementById('loginError');
                
                errorEl.classList.add('hidden');

                // Logika login diubah untuk mengecek ke Supabase
                try {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .eq('password', password) // Catatan: Menyimpan password sebagai teks biasa tidak aman untuk produksi!
                        .eq('role', role)
                        .single(); // Ambil satu data

                    if (error && !user) {
                        throw new Error('Username atau password salah.');
                    }

                    if (user) {
                        // Pengecekan status
                        if (user.status && user.status !== 'approved') {
                            errorEl.textContent = 'Akun Anda belum disetujui oleh admin.';
                            errorEl.classList.remove('hidden');
                            return;
                        }
                        
                        state.currentUserRole = user.role;
                        state.currentUserName = user.nama;
                        state.currentUserId = user.id;
                        saveState(); // Simpan sesi login ke localStorage
                        main(); // Muat ulang dashboard
                    } else {
                        errorEl.textContent = 'Username atau password salah.';
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                }
            };

            const handleLogout = () => {
                state.currentUserRole = null;
                state.currentUserName = null;
                state.currentUserId = null;
                saveState(); // Simpan sesi (kosong) ke localStorage
                main();
            };

            const handleKumpulTugas = (tugasId) => {
                const tugas = state.tugas.find(t => t.id === parseInt(tugasId));
                renderModal({
                    title: `Kumpulkan: ${tugas.judul}`,
                    body: `
                        <p class="mb-4 text-base">Silakan unggah file tugas Anda. Pastikan format file sesuai.</p>
                        <input type="file" id="file-upload" class="w-full p-2 border rounded-md">
                        <p id="file-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    `,
                    footer: `
                        <button type="button" data-action="close-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                        <button type="button" data-action="submit-kumpul" data-id="${tugas.id}" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Unggah</button>
                    `
                });
            };

            const handleSubmitKumpul = async (tugasId) => {
                const fileInput = document.getElementById('file-upload');
                const file = fileInput.files[0];
                const errorEl = document.getElementById('file-error');

                if (!file) {
                    errorEl.textContent = 'Silakan pilih file untuk diunggah.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                // Buat ID baru yang unik (menggunakan timestamp sederhana)
                const newId = new Date().getTime();

                const newPengumpulan = {
                    id: newId, 
                    tugasId: parseInt(tugasId),
                    siswaId: state.currentUserId,
                    namaSiswa: state.currentUserName,
                    file: { name: file.name, size: file.size },
                    tanggalKumpul: new Date(),
                    nilai: null,
                    komentarGuru: null
                };
                
                // Data untuk dikirim ke Supabase
                const dataToInsert = {
                    id: newPengumpulan.id,
                    tugasId: newPengumpulan.tugasId,
                    siswaId: newPengumpulan.siswaId,
                    namaSiswa: newPengumpulan.namaSiswa,
                    file_name: newPengumpulan.file.name,
                    file_size: newPengumpulan.file.size,
                    tanggalKumpul: newPengumpulan.tanggalKumpul.toISOString(), // Kirim sebagai string ISO
                    nilai: null,
                    komentarGuru: null
                };

                try {
                    const { error } = await supabase.from('pengumpulan').insert(dataToInsert);
                    if (error) throw error;

                    // Jika sukses di DB, tambahkan ke state lokal dan render ulang
                    state.pengumpulan.push(newPengumpulan);
                    // saveState(); // Tidak perlu lagi, data sudah di DB
                    closeModal();
                    showNotification('Tugas berhasil dikumpulkan!');
                    renderSiswaDashboard();

                } catch (error) {
                    console.error('Error submitting assignment:', error.message);
                    errorEl.textContent = 'Gagal mengunggah: ' + error.message;
                    errorEl.classList.remove('hidden');
                }
            };

            const handleLihatTugas = (pengumpulanId) => {
                 const pengumpulan = state.pengumpulan.find(p => p.id === parseInt(pengumpulanId));
                 if (!pengumpulan) return;

                 renderModal({
                    title: `Detail Pengumpulan: ${pengumpulan.namaSiswa}`,
                    body: `
                        <div class="space-y-3">
                            <p><strong class="font-medium">Siswa:</strong> ${pengumpulan.namaSiswa}</p>
                            <p><strong class="font-medium">File:</strong> <i class="fas fa-file-alt mr-1"></i>${pengumpulan.file.name}</p>
                            <p><strong class="font-medium">Ukuran File:</strong> ${(pengumpulan.file.size / 1024).toFixed(2)} KB</p>
                            <p><strong class="font-medium">Tanggal Kumpul:</strong> ${formatDate(pengumpulan.tanggalKumpul)}</p>
                            <p class="mt-4 text-sm text-gray-500">(Pratinjau file tidak tersedia dalam demo ini. Klik file akan mengunduhnya.)</p>
                        </div>
                    `,
                    footer: `
                        <button type="button" data-action="close-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Tutup</button>
                    `
                 });
            };

            const handleSimpanPenilaian = async (pengumpulanId) => {
                const id = parseInt(pengumpulanId);
                const pengumpulan = state.pengumpulan.find(p => p.id === id);
                
                const nilaiInput = document.querySelector(`.nilai-input[data-id="${id}"]`);
                const komentarInput = document.querySelector(`.komentar-input[data-id="${id}"]`);

                if (pengumpulan && nilaiInput && komentarInput) {
                    const nilaiBaru = parseInt(nilaiInput.value) || null;
                    const komentarBaru = komentarInput.value;

                    try {
                        const { error } = await supabase
                            .from('pengumpulan')
                            .update({ nilai: nilaiBaru, komentarGuru: komentarBaru })
                            .eq('id', id);
                        
                        if (error) throw error;

                        // Jika sukses di DB, update state lokal
                        pengumpulan.nilai = nilaiBaru;
                        pengumpulan.komentarGuru = komentarBaru;
                        // saveState(); // Tidak perlu
                        showNotification(`Penilaian untuk ${pengumpulan.namaSiswa} berhasil disimpan.`);
                    
                    } catch (error) {
                         console.error('Error saving grade:', error.message);
                         showNotification('Gagal menyimpan penilaian: ' + error.message, 'error');
                    }
                }
            };
            
            const handleTambahTugas = () => {
                renderModal({
                    title: 'Tambah Tugas Baru',
                    body: `
                        <form id="tugas-baru-form" class="space-y-4">
                            <div>
                                <label for="tugas-judul" class="block mb-1 font-medium">Judul Tugas</label>
                                <input type="text" id="tugas-judul" class="w-full p-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="tugas-deskripsi" class="block mb-1 font-medium">Deskripsi</label>
                                <textarea id="tugas-deskripsi" class="w-full p-2 border rounded-md" rows="4" required></textarea>
                            </div>
                            <div>
                                <label for="tugas-deadline" class="block mb-1 font-medium">Deadline</label>
                                <input type="datetime-local" id="tugas-deadline" class="w-full p-2 border rounded-md" required value="${toDateTimeLocal(new Date())}">
                            </div>
                             <p id="tugas-error" class="text-red-500 text-sm hidden"></p>
                        </form>
                    `,
                    footer: `
                        <button type="button" data-action="close-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                        <button type="button" data-action="submit-tugas-baru" class="bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700">Simpan Tugas</button>
                    `
                });
            };

            const handleSubmitTugasBaru = async () => {
                const judul = document.getElementById('tugas-judul').value;
                const deskripsi = document.getElementById('tugas-deskripsi').value;
                const deadline = document.getElementById('tugas-deadline').value;
                const errorEl = document.getElementById('tugas-error');

                if (!judul || !deskripsi || !deadline) {
                    errorEl.textContent = 'Semua field harus diisi.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                const newId = new Date().getTime(); // ID unik
                
                const newTugas = {
                    id: newId,
                    judul: judul,
                    deskripsi: deskripsi,
                    deadline: new Date(deadline)
                };

                const dataToInsert = {
                    id: newTugas.id,
                    judul: newTugas.judul,
                    deskripsi: newTugas.deskripsi,
                    deadline: newTugas.deadline.toISOString() // Kirim sebagai string ISO
                };

                try {
                    const { error } = await supabase.from('tugas').insert(dataToInsert);
                    if (error) throw error;

                    // Jika sukses di DB, tambahkan ke state lokal
                    state.tugas.push(newTugas);
                    // saveState(); // Tidak perlu
                    closeModal();
                    showNotification('Tugas baru berhasil ditambahkan.');
                    renderGuruDashboard();
                } catch (error) {
                    console.error('Error adding task:', error.message);
                    errorEl.textContent = 'Gagal menyimpan: ' + error.message;
                    errorEl.classList.remove('hidden');
                }
            };

            const openUserModal = (userId = null) => {
                userForm.reset();
                userError.classList.add('hidden');
                
                if (userId) {
                    // Edit mode
                    const allUsers = [...state.users.guru, ...state.users.siswa];
                    const user = allUsers.find(u => u.id === parseInt(userId));
                    if (!user) return;

                    const role = state.users.guru.includes(user) ? 'guru' : 'siswa';
                    
                    userModalTitle.textContent = 'Edit Pengguna';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-nama').value = user.nama;
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-username').disabled = true; // Don't allow username change
                    document.getElementById('user-role').value = role;
                    passwordHint.classList.remove('hidden');
                    document.getElementById('user-password').required = false;

                } else {
                    // Add mode
                    userModalTitle.textContent = 'Tambah Pengguna';
                    document.getElementById('user-id').value = '';
                    document.getElementById('user-username').disabled = false;
                    passwordHint.classList.add('hidden');
                    document.getElementById('user-password').required = true;
                }
                userModal.classList.add('flex');
                userModal.classList.remove('hidden');
            };

            const closeUserModal = () => {
                userModal.classList.add('hidden');
                userModal.classList.remove('flex');
                userForm.reset();
            };
            
            const handleUserFormSubmit = async (event) => {
                event.preventDefault();
                userError.classList.add('hidden');

                const id = document.getElementById('user-id').value;
                const nama = document.getElementById('user-nama').value;
                const username = document.getElementById('user-username').value;
                const password = document.getElementById('user-password').value;
                const role = document.getElementById('user-role').value;

                const allUsernames = [...state.users.guru, ...state.users.siswa, ...state.users.superadmin].map(u => u.username);

                try {
                    if (id) {
                        // --- EDIT PENGGUNA ---
                        const currentRoleList = state.users.guru.find(u => u.id === parseInt(id)) ? state.users.guru : state.users.siswa;
                        const user = currentRoleList.find(u => u.id === parseInt(id));
                        
                        if (user) {
                            const dataToUpdate = {
                                nama: nama,
                                role: role
                            };
                            if (password) { // Hanya update password jika diisi
                                dataToUpdate.password = password;
                            }

                            const { error } = await supabase.from('users').update(dataToUpdate).eq('id', id);
                            if (error) throw error;
                            
                            // Update state lokal
                            user.nama = nama;
                            user.role = role;
                            if (password) user.password = password;

                            // Cek jika role berubah & pindahkan di state lokal
                            const oldRole = currentRoleList === state.users.guru ? 'guru' : 'siswa';
                            if (oldRole !== role) {
                                const index = currentRoleList.findIndex(u => u.id === parseInt(id));
                                currentRoleList.splice(index, 1);
                                state.users[role].push(user);
                            }
                            
                            showNotification('Data pengguna berhasil diperbarui.');
                        }
                    } else {
                        // --- TAMBAH PENGGUNA BARU ---
                        if (!password) {
                            userError.textContent = 'Password wajib diisi untuk pengguna baru.';
                            userError.classList.remove('hidden');
                            return;
                        }
                        // Cek username di DB, bukan cuma state
                        const { data: existingUser, error: checkError } = await supabase.from('users').select('username').eq('username', username).single();
                        
                        if (existingUser) {
                            userError.textContent = 'Username sudah digunakan. Silakan pilih yang lain.';
                            userError.classList.remove('hidden');
                            return;
                        }
                        
                        const newId = new Date().getTime(); // ID unik
                        const newUser = {
                            id: newId, 
                            username: username,
                            password: password,
                            nama: nama,
                            role: role,
                            status: 'approved' // Otomatis approve
                        };
                        
                        const { error: insertError } = await supabase.from('users').insert(newUser);
                        if (insertError) throw insertError;

                        // Tambahkan ke state lokal
                        state.users[role].push(newUser);
                        showNotification('Pengguna baru berhasil ditambahkan.');
                    }

                    // saveState(); // Tidak perlu
                    closeUserModal();
                    renderSuperAdminDashboard();
                
                } catch (error) {
                    console.error('Error saving user:', error.message);
                    userError.textContent = 'Gagal menyimpan: ' + error.message;
                    userError.classList.remove('hidden');
                }
            };

            const handleDeleteUser = (userId) => {
                 const id = parseInt(userId);
                 const allUsers = [...state.users.guru, ...state.users.siswa];
                 const user = allUsers.find(u => u.id === id);
                 if (!user) return;

                 renderModal({
                    title: 'Konfirmasi Hapus Pengguna',
                    body: `
                        <p class="text-base">Apakah Anda yakin ingin menghapus pengguna <strong class="font-medium">${user.nama}</strong> (${user.username})?</p>
                        <p class="text-base text-red-600 mt-2">Tindakan ini tidak dapat dibatalkan.</p>
                    `,
                    footer: `
                        <button type="button" data-action="close-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-400">Batal</button>
                        <button type="button" data-action="confirm-delete-user" data-id="${id}" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Hapus</button>
                    `
                 });
            };

            const handleConfirmDeleteUser = async (userId) => {
                const id = parseInt(userId);
                
                try {
                    // Hapus data terkait (pengumpulan) terlebih dahulu jika dia siswa
                    const isSiswa = state.users.siswa.find(u => u.id === id);
                    if (isSiswa) {
                        const { error: deletePengumpulanError } = await supabase.from('pengumpulan').delete().eq('siswaId', id);
                        if (deletePengumpulanError) throw deletePengumpulanError;
                    }

                    // Hapus pengguna
                    const { error: deleteUserError } = await supabase.from('users').delete().eq('id', id);
                    if (deleteUserError) throw deleteUserError;

                    // Hapus dari state lokal
                    let index = state.users.guru.findIndex(u => u.id === id);
                    if (index > -1) {
                        state.users.guru.splice(index, 1);
                    } else {
                        index = state.users.siswa.findIndex(u => u.id === id);
                        if (index > -1) {
                            state.users.siswa.splice(index, 1);
                        }
                    }
                    
                    // Hapus juga pengumpulan dari state lokal
                    if (isSiswa) {
                        state.pengumpulan = state.pengumpulan.filter(p => p.siswaId !== id);
                    }
                    
                    // saveState(); // Tidak perlu
                    closeModal();
                    showNotification('Pengguna berhasil dihapus.');
                    renderSuperAdminDashboard();

                } catch (error) {
                    console.error('Error deleting user:', error.message);
                    closeModal();
                    showNotification('Gagal menghapus pengguna: ' + error.message, 'error');
                }
            };


            // =================================================================================
            // MAIN ROUTER & APP INITIALIZATION
            // =================================================================================

            const main = async () => {
                // Pertama, muat semua data dari database
                const success = await loadDataFromSupabase();

                // Jika gagal memuat data (misal: RLS masih aktif), hentikan
                if (!success) return; 

                // Setelah data ada, baru tentukan halaman mana yang ditampilkan
                // berdasarkan sesi login (yang dimuat dari localStorage)
                if (state.currentUserRole === 'superadmin') {
                    renderSuperAdminDashboard();
                } else if (state.currentUserRole === 'guru') {
                    renderGuruDashboard();
                } else if (state.currentUserRole === 'siswa') {
                    renderSiswaDashboard();
                } else {
                    renderLogin();
                }
            };

            // Global Event Listener (Event Delegation)
            document.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]');
                if (!action) return;

                const actionName = action.dataset.action;
                const id = action.dataset.id;

                switch (actionName) {
                    case 'logout':
                        handleLogout();
                        break;
                    case 'kumpul-tugas':
                        handleKumpulTugas(id);
                        break;
                    case 'close-modal':
                        closeModal();
                        break;
                    case 'submit-kumpul':
                        handleSubmitKumpul(id);
                        break;
                    case 'lihat-tugas':
                        handleLihatTugas(id);
                        break;
                    case 'simpan-penilaian':
                        handleSimpanPenilaian(id);
                        break;
                    case 'tambah-tugas':
                        handleTambahTugas();
                        break;
                    case 'submit-tugas-baru':
                        handleSubmitTugasBaru();
                        break;
                    case 'add-user':
                        openUserModal();
                        break;
                    case 'edit-user':
                        openUserModal(id);
                        break;
                    case 'delete-user':
                        handleDeleteUser(id);
                        break;
                    case 'confirm-delete-user':
                        handleConfirmDeleteUser(id);
                        break;
                    case 'close-user-modal':
                        closeUserModal();
                        break;
                }
            });
            
            // Listener untuk form admin
            userForm.addEventListener('submit', handleUserFormSubmit);

            // Fungsi inisialisasi baru
            const initializeApp = () => {
                loadState(); // Muat sesi login dari localStorage
                main();      // Panggil main (yang akan memuat data dari Supabase lalu render)
            };

            // Initial Load
            initializeApp();
        });
    </script>
</body>
</html>
